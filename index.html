<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planos por Piso</title>
  <style>
    body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 20px; background: #f9fafb; color: #333; }
    h1 { text-align: center; font-weight: 700; font-size: 2.2rem; margin-bottom: 40px; color: #222; }
    .plano-container { margin: 0 auto 50px; max-width: 900px; border-radius: 10px; box-shadow: 0 6px 15px rgba(0,123,255,0.2); background: #fff; overflow: hidden; position: relative; }
    .plano-titulo { text-align: center; font-weight: 700; padding: 15px 0; background-color: #007BFF; color: #fff; font-size: 1.5rem; }
    .plano-botones { text-align: center; margin: 10px 0 20px; }
    .plano-botones button { margin: 5px; padding: 8px 14px; font-size: 14px; font-weight: 600; border: none; border-radius: 6px; cursor: pointer; background-color: #007BFF; color: white; transition: background-color 0.3s; }
    .plano-botones button:hover { background-color: #0056b3; }
    svg { display: block; margin: 10px auto 0; max-width: 100%; height: auto; background: #f7f9fc; }
    .Habitacion { fill: #e2e8f0; stroke: #3b82f6; stroke-width: 3; }
    text { font-size: 14px; font-weight: 600; pointer-events: none; user-select: none; }
    .qr-border { fill: white; stroke: #007BFF; stroke-width: 2; rx: 6; ry: 6; }
    .qr-image { pointer-events: none; }
    .usuario-animado { transform: translate(-12px, -12px); }
    #modal-identificacion { display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:9999; justify-content:center; align-items:center; }
    #modal-identificacion > div { background:white; padding:30px; border-radius:10px; box-shadow:0 6px 20px rgba(0,0,0,0.3); width:90%; max-width:400px; text-align:center; }
    #modal-identificacion input { width:100%; padding:10px; margin:15px 0; border:1px solid #ccc; border-radius:6px; font-size:16px; }
    #modal-identificacion button { padding:10px 20px; background-color:#007BFF; color:white; border:none; border-radius:6px; font-size:16px; cursor:pointer; }
  </style>
</head>
<body>

<h1>Ubica tu XXX</h1>
<div id="contenedor-planos"></div>

<!-- Modal de identificaci√≥n -->
<div id="modal-identificacion">
  <div>
    <h2>Identificaci√≥n requerida</h2>
    <p>Por favor, ingresa tu nombre o n√∫mero de ID:</p>
    <input id="input-identificacion" type="text" placeholder="Ej: Juan P√©rez o 12345" />
    <button onclick="registrarIngreso()">Ingresar</button>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  const svgNS = "http://www.w3.org/2000/svg";
  const baseUrl = 'https://usuariodesarrollo.github.io/planos-rutas-qr/';
  const entrada = { x:10, y:170, width:60, height:60 };
  const entradaCenter = { x:entrada.x+entrada.width/2, y:entrada.y+entrada.height/2 };
  const pisos = 3;
  const HabitacionesPorPiso = 10;
  const Habitaciones = [];
  let haInteraccionado = false;
  document.addEventListener('click', ()=>haInteraccionado = true);
  document.addEventListener('touchstart', ()=>haInteraccionado = true);
  for(let piso=1;piso<=pisos;piso++){
    for(let i=1;i<=HabitacionesPorPiso;i++){
      const id = piso*100+i;
      const fila = i<=5?50:250;
      const col = ((i-1)%5)*140+100;
      Habitaciones.push({ id, piso, x:col, y:fila, width:120, height:120 });
    }
  }
  function createText(x,y,content,opts={}){
    const t = document.createElementNS(svgNS,'text');
    t.setAttribute('x',x);
    t.setAttribute('y',y);
    t.textContent = content;
    t.setAttribute('fill',opts.fill||'#000');
    t.setAttribute('font-weight',opts.fontWeight||'bold');
    if(opts.anchor) t.setAttribute('text-anchor',opts.anchor);
    return t;
  }
  function crearLinea(x1,y1,x2,y2){
    const l = document.createElementNS(svgNS,'line');
    l.setAttribute('x1',x1);l.setAttribute('y1',y1);
    l.setAttribute('x2',x2);l.setAttribute('y2',y2);
    l.setAttribute('stroke','#FF0000');l.setAttribute('stroke-width','3');
    return l;
  }
  function crearFlecha(x,y,d){
    const p = document.createElementNS(svgNS,'path');
    const s=10; let dd='';
    if(d==='right') dd=`M${x-s},${y-s} L${x},${y} L${x-s},${y+s}`;
    if(d==='left') dd=`M${x+s},${y-s} L${x},${y} L${x+s},${y+s}`;
    if(d==='up') dd=`M${x-s},${y+s} L${x},${y} L${x+s},${y+s}`;
    if(d==='down') dd=`M${x-s},${y-s} L${x},${y} L${x+s},${y-s}`;
    p.setAttribute('d',dd);
    p.setAttribute('fill','none');
    p.setAttribute('stroke','#007BFF');
    p.setAttribute('stroke-width','3');
    p.setAttribute('stroke-linecap','round');
    p.setAttribute('stroke-linejoin','round');
    return p;
  }

  const cont = document.getElementById('contenedor-planos');
  function crearPlanoParaHabitacion(idHab,piso){
    const MPs = Habitaciones.filter(h=>h.piso===piso);
    const div = document.createElement('div');
    div.className='plano-container';
    const cab = document.createElement('div');
    cab.className='plano-titulo';
    cab.textContent=`Piso ${piso} ‚Äì Ruta a Habitaci√≥n ${idHab}`;
    div.appendChild(cab);
    const svg = document.createElementNS(svgNS,'svg');
    svg.setAttribute('width','900');
    svg.setAttribute('height','400');
    svg.setAttribute('viewBox','0 0 900 400');
    const re = document.createElementNS(svgNS,'rect');
    re.setAttribute('x',entrada.x);re.setAttribute('y',entrada.y);
    re.setAttribute('width',entrada.width);re.setAttribute('height',entrada.height);
    re.setAttribute('fill','green');
    svg.appendChild(re);
    svg.appendChild(createText(entrada.x+entrada.width/2, entrada.y-8, 'Entrada', { fill:'green', anchor:'middle' }));
    const groupH = document.createElementNS(svgNS,'g');
    const groupR = document.createElementNS(svgNS,'g');
    svg.appendChild(groupH);svg.appendChild(groupR);

    MPs.forEach(h=>{
      const puerta = (h.y<150)
        ? {x:h.x, y:h.y+h.height/2}
        : {x:h.x+h.width, y:h.y+h.height/2};
      const rect = document.createElementNS(svgNS,'rect');
      rect.setAttribute('x',h.x);rect.setAttribute('y',h.y);
      rect.setAttribute('width',h.width);rect.setAttribute('height',h.height);
      rect.setAttribute('class','Habitacion');
      groupH.appendChild(rect);

      const titulo = createText(h.x+h.width/2, h.y-5, `Habitaci√≥n ${h.id}`, { anchor:'middle' });
      groupH.appendChild(titulo);

      if(h.id===idHab){
        const tramo1 = crearLinea(entradaCenter.x+10,entradaCenter.y,puerta.x,entradaCenter.y);
        const tramo2 = crearLinea(puerta.x,entradaCenter.y,puerta.x,puerta.y);
        groupR.appendChild(tramo1);
        groupR.appendChild(tramo2);
        const dir = puerta.y<entradaCenter.y?'up':puerta.y>entradaCenter.y?'down':puerta.x<entradaCenter.x?'left':'right';
        groupR.appendChild(crearFlecha(puerta.x,puerta.y,dir));
        const path = document.createElementNS(svgNS,'path');
        path.setAttribute('d',`M${entradaCenter.x+10},${entradaCenter.y} L${puerta.x},${entradaCenter.y} L${puerta.x},${puerta.y}`);
        path.setAttribute('fill','none');
        path.setAttribute('id',`ruta-${h.id}`);
        path.style.visibility='hidden';
        groupR.appendChild(path);
        const img = document.createElementNS(svgNS,'image');
        img.setAttribute('width',24);img.setAttribute('height',24);
        img.setAttributeNS('http://www.w3.org/1999/xlink','href','https://cdn-icons-png.flaticon.com/512/847/847969.png');
        img.classList.add('usuario-animado');
        const anim = document.createElementNS(svgNS,'animateMotion');
        anim.setAttribute('dur','4s');
        anim.setAttribute('repeatCount','indefinite');
        const mpath = document.createElementNS(svgNS,'mpath');
        mpath.setAttributeNS('http://www.w3.org/1999/xlink','href',`#ruta-${h.id}`);
        anim.appendChild(mpath);
        img.appendChild(anim);
        groupR.appendChild(img);

        const center = { x:h.x+h.width/2, y:h.y+h.height/2 };
        const canvas = document.createElement('canvas');
        QRCode.toCanvas(canvas, baseUrl+'?hab='+h.id, { width:80, margin:1 }, err=>{
          if(err) console.error(err);
          const qrB = document.createElementNS(svgNS,'rect');
          qrB.setAttribute('x',center.x-42);
          qrB.setAttribute('y',center.y-42);
          qrB.setAttribute('width',84);
          qrB.setAttribute('height',84);
          qrB.setAttribute('class','qr-border');
          groupH.appendChild(qrB);
          const qrImg = document.createElementNS(svgNS,'image');
          qrImg.setAttribute('width',80); qrImg.setAttribute('height',80);
          qrImg.setAttribute('x',center.x-40); qrImg.setAttribute('y',center.y-40);
          qrImg.setAttributeNS('http://www.w3.org/1999/xlink','href',canvas.toDataURL());
          qrImg.setAttribute('class','qr-image');
          groupH.appendChild(qrImg);
        });

        const log = JSON.parse(localStorage.getItem('logIngreso') || '{}');
        if(log.id && log.horaIngreso){
          const f = new Date(log.horaIngreso);
          groupH.appendChild(createText(center.x, h.y+50, `ID: ${log.id}`, { anchor:'middle', fill:'#111', fontWeight:'normal' }));
          groupH.appendChild(createText(center.x, h.y+70, `${f.toLocaleDateString()} - ${f.toLocaleTimeString()}`, { anchor:'middle', fill:'#555', fontWeight:'normal' }));
        }

        setTimeout(()=>hablar(`Te encuentras en el piso ${piso}. Ruta a la habitaci√≥n ${h.id}. Sigue la flecha roja.`),500);
      }
    });
    svg.appendChild(groupH); svg.appendChild(groupR);
    div.appendChild(svg);

    const botones = document.createElement('div');
    botones.className='plano-botones';
    const btnI = document.createElement('button');
    btnI.textContent='üñ®Ô∏è Imprimir';
    btnI.onclick=()=>{const w=window.open('','width=960,height=600');w.document.write('<html><head><title>Imprimir</title><style>body{margin:0;}svg{width:100%;}</style></head><body>'+svg.outerHTML+'</body></html>');w.document.close();setTimeout(()=>w.print(),500);};
    const btnC = document.createElement('button');
    btnC.textContent='üîó Compartir';
    btnC.onclick=async()=>{const u=baseUrl+'?hab='+idHab;try{await navigator.clipboard.writeText(u);alert(`Enlace copiado:\n${u}`);}catch{alert('No se pudo copiar.');}};
    const btnA = document.createElement('button');
    btnA.textContent='üîä Escuchar ruta';
    btnA.onclick=()=>hablar(`Te encuentras en el piso ${piso}. Ruta a la habitaci√≥n ${idHab}. Sigue la flecha roja.`, true);

    botones.appendChild(btnI);
    botones.appendChild(btnC);
    botones.appendChild(btnA);
    div.appendChild(botones);

    return div;
  }

  const params = new URLSearchParams(window.location.search);
  const habParam = parseInt(params.get('hab'), 10);
  if(!isNaN(habParam)){
    cont.appendChild(crearPlanoParaHabitacion(habParam, Math.floor(habParam/100)));
  } else {
    Habitaciones.filter(h=>h.piso===1).forEach(h=>cont.appendChild(crearPlanoParaHabitacion(h.id,1)));
  }

  window.addEventListener('load', ()=>document.getElementById('modal-identificacion').style.display='flex');

  let logUsuario = { id:'', horaIngreso:'', horaSalida:'' };
  function registrarIngreso(){
    const id = document.getElementById('input-identificacion').value.trim();
    if(!id){alert('Identificaci√≥n v√°lida requerida'); return;}
    logUsuario.id = id;
    logUsuario.horaIngreso = new Date().toISOString();
    localStorage.setItem('logIngreso', JSON.stringify(logUsuario));
    document.getElementById('modal-identificacion').style.display='none';
    location.reload();
  }

  window.addEventListener('beforeunload', ()=>{
    logUsuario.horaSalida = new Date().toISOString();
    localStorage.setItem('logSalida', JSON.stringify(logUsuario));
  });

  function hablar(txt,forzado=false){
    if(!('speechSynthesis' in window)) return;
    if(!haInteraccionado && !forzado) return;
    window.speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(txt);
    u.lang='es-ES'; u.rate=1; u.pitch=1;
    window.speechSynthesis.speak(u);
  }
</script>
</body>
</html>
