<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planos con Ruta Individual y QR</title>
  <style>
    body { font-family: Arial, sans-serif; margin: 20px; }
    h1 { text-align: center; }
    .plano-container {
      margin-bottom: 50px;
      border: 2px solid #444;
      background: #f0f0f0;
      width: 900px;
      margin: 0 auto;
    }
    .plano-titulo {
      text-align: center;
      font-weight: bold;
      padding: 8px 0;
      background-color: #007BFF;
      color: white;
      font-size: 18px;
    }
    svg { display: block; margin: 0 auto; }
    .habitacion { fill: #ccc; stroke: #333; stroke-width: 2; }
    .qr-image { pointer-events: none; }
  </style>
</head>
<body>
  <h1>Planos con Ruta Individual y QR</h1>
  <div id="contenedor-planos"></div>

  <script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
  <script>
    const svgNS = "http://www.w3.org/2000/svg";
    const baseUrl = 'https://joalcabadesarrollo.github.io/planos-rutas-qr/index.html';
    const entrada = { x: 10, y: 170, width: 60, height: 60 };
    const entradaCenter = { x: entrada.x + entrada.width/2, y: entrada.y + entrada.height/2 };

    const habitaciones = Array.from({ length: 10 }, (_, i) => {
      const fila = i < 5 ? 50 : 250;
      const col = (i % 5) * 140 + 100;
      return { id: i + 1, x: col, y: fila, width: 120, height: 120 };
    });

    function createText(x, y, content) {
      const t = document.createElementNS(svgNS, 'text');
      t.setAttribute('x', x);
      t.setAttribute('y', y);
      t.textContent = content;
      t.setAttribute('fill', '#000');
      t.setAttribute('font-weight', 'bold');
      return t;
    }

    function crearLinea(x1, y1, x2, y2) {
      const line = document.createElementNS(svgNS, 'line');
      line.setAttribute('x1', x1);
      line.setAttribute('y1', y1);
      line.setAttribute('x2', x2);
      line.setAttribute('y2', y2);
      line.setAttribute('stroke', '#007BFF');
      line.setAttribute('stroke-width', '3');
      return line;
    }

    function crearPlanoParaHabitacion(idHabitacion) {
      const contPlano = document.createElement('div');
      contPlano.classList.add('plano-container');

      const titulo = document.createElement('div');
      titulo.classList.add('plano-titulo');
      titulo.textContent = `Plano con Ruta a Habitación ${idHabitacion}`;
      contPlano.appendChild(titulo);

      const svg = document.createElementNS(svgNS, 'svg');
      svg.setAttribute('width', '900');
      svg.setAttribute('height', '400');
      svg.setAttribute('viewBox', '0 0 900 400');
      contPlano.appendChild(svg);

      // Dibujar entrada
      const rectE = document.createElementNS(svgNS, 'rect');
      Object.entries(entrada).forEach(([k, v]) => rectE.setAttribute(k, v));
      rectE.setAttribute('fill', 'green');
      svg.appendChild(rectE);

      const txtE = document.createElementNS(svgNS, 'text');
      txtE.setAttribute('x', entrada.x + 10);
      txtE.setAttribute('y', entrada.y + 35);
      txtE.setAttribute('fill', 'white');
      txtE.setAttribute('font-weight', 'bold');
      txtE.textContent = 'Entrada';
      svg.appendChild(txtE);

      const rutasGroup = document.createElementNS(svgNS, 'g');
      const habitacionesGroup = document.createElementNS(svgNS, 'g');
      svg.append(rutasGroup, habitacionesGroup);

      habitaciones.forEach(h => {
        const puerta = h.y < 150
          ? { x: h.x, y: h.y + h.height / 2 }
          : { x: h.x + h.width, y: h.y + h.height / 2 };

        const rect = document.createElementNS(svgNS, 'rect');
        ['x', 'y', 'width', 'height'].forEach(k => rect.setAttribute(k, h[k]));
        rect.setAttribute('class', 'habitacion');
        habitacionesGroup.appendChild(rect);

        habitacionesGroup.appendChild(createText(h.x + 10, h.y + 20, `Habitación ${h.id}`));

        if (h.id === idHabitacion) {
          rutasGroup.appendChild(crearLinea(entradaCenter.x, entradaCenter.y, puerta.x, entradaCenter.y));
          rutasGroup.appendChild(crearLinea(puerta.x, entradaCenter.y, puerta.x, puerta.y));

          const urlPlano = `${baseUrl}?hab=${h.id}`;
          const canvas = document.createElement('canvas');

          QRCode.toCanvas(canvas, urlPlano, { width: 80, margin: 1 }, (err) => {
            if (err) console.error(err);
            const img = document.createElementNS(svgNS, 'image');
            const cx = h.x + h.width / 2;
            const cy = h.y + h.height / 2;
            img.setAttribute('x', cx - 40);
            img.setAttribute('y', cy - 40);
            img.setAttribute('width', 80);
            img.setAttribute('height', 80);
            img.setAttributeNS('http://www.w3.org/1999/xlink', 'href', canvas.toDataURL());
            img.setAttribute('class', 'qr-image');
            habitacionesGroup.appendChild(img);
          });
        }
      });

      return contPlano;
    }

    const contenedor = document.getElementById('contenedor-planos');
    for (let i = 1; i <= 10; i++) {
      contenedor.appendChild(crearPlanoParaHabitacion(i));
    }
  </script>
</body>
</html>
