<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Plano Individual con Ruta y QR</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
    }

    h1 {
      text-align: center;
    }

    .plano-container {
      margin: 0 auto 50px auto;
      border: 2px solid #444;
      background: #f0f0f0;
      max-width: 900px;
      padding: 20px;
    }

    .plano-titulo {
      text-align: center;
      font-weight: bold;
      padding: 8px 0;
      background-color: #007BFF;
      color: white;
      font-size: 18px;
    }

    svg {
      width: 100%;
      height: auto;
      display: block;
      margin: 0 auto;
    }

    .habitacion {
      fill: #ccc;
      stroke: #333;
      stroke-width: 2;
    }

    text {
      font-size: 14px;
      pointer-events: none;
      user-select: none;
    }

    .qr-container {
      text-align: center;
      margin-top: 10px;
    }

    .qr-container img {
      width: 100px;
      height: 100px;
    }
  </style>
</head>
<body>

<h1>Plano con Ruta Individual y QR</h1>

<div id="contenedor-plano"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  const svgNS = "http://www.w3.org/2000/svg";
  const baseUrl = 'https://joalcabadesarrollo.github.io/planos-rutas-qr/';

  const entrada = { x: 10, y: 170, width: 60, height: 60 };
  const entradaCenter = {
    x: entrada.x + entrada.width / 2,
    y: entrada.y + entrada.height / 2
  };

  const habitaciones = [];
  for (let i = 1; i <= 10; i++) {
    const fila = i <= 5 ? 50 : 250;
    const col = ((i - 1) % 5) * 140 + 100;
    habitaciones.push({ id: i, x: col, y: fila, width: 120, height: 120 });
  }

  const urlParams = new URLSearchParams(window.location.search);
  const habID = parseInt(urlParams.get('hab'), 10);

  if (!habID || habID < 1 || habID > 10) {
    document.getElementById('contenedor-plano').innerHTML = `
      <p style="text-align:center;color:red;">
        Por favor, proporciona una URL válida como <code>?hab=1</code> hasta <code>?hab=10</code>
      </p>`;
  } else {
    crearPlanoParaHabitacion(habID);
  }

  function createText(x, y, content) {
    const t = document.createElementNS(svgNS, 'text');
    t.setAttribute('x', x);
    t.setAttribute('y', y);
    t.textContent = content;
    t.setAttribute('fill', '#000');
    t.setAttribute('font-weight', 'bold');
    return t;
  }

  function crearLinea(x1, y1, x2, y2) {
    const line = document.createElementNS(svgNS, 'line');
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
    line.setAttribute('stroke', '#007BFF');
    line.setAttribute('stroke-width', '3');
    return line;
  }

  function crearPlanoParaHabitacion(idHabitacion) {
    const contPlano = document.getElementById('contenedor-plano');
    contPlano.classList.add('plano-container');

    const titulo = document.createElement('div');
    titulo.classList.add('plano-titulo');
    titulo.textContent = `Plano con Ruta a Habitación ${idHabitacion}`;
    contPlano.appendChild(titulo);

    const svg = document.createElementNS(svgNS, 'svg');
    svg.setAttribute('viewBox', '0 0 900 400');

    const rectEntrada = document.createElementNS(svgNS, 'rect');
    rectEntrada.setAttribute('x', entrada.x);
    rectEntrada.setAttribute('y', entrada.y);
    rectEntrada.setAttribute('width', entrada.width);
    rectEntrada.setAttribute('height', entrada.height);
    rectEntrada.setAttribute('fill', 'green');
    svg.appendChild(rectEntrada);

    const textoEntrada = document.createElementNS(svgNS, 'text');
    textoEntrada.setAttribute('x', entrada.x + 10);
    textoEntrada.setAttribute('y', entrada.y + 35);
    textoEntrada.setAttribute('fill', 'white');
    textoEntrada.setAttribute('font-weight', 'bold');
    textoEntrada.textContent = 'Entrada';
    svg.appendChild(textoEntrada);

    const rutasGroup = document.createElementNS(svgNS, 'g');
    svg.appendChild(rutasGroup);

    const habitacionesGroup = document.createElementNS(svgNS, 'g');
    svg.appendChild(habitacionesGroup);

    let targetHabitacion = null;

    habitaciones.forEach(h => {
      const puerta = {};
      if (h.y < 150) {
        puerta.x = h.x;
        puerta.y = h.y + h.height / 2;
      } else {
        puerta.x = h.x + h.width;
        puerta.y = h.y + h.height / 2;
      }

      const rect = document.createElementNS(svgNS, 'rect');
      rect.setAttribute('x', h.x);
      rect.setAttribute('y', h.y);
      rect.setAttribute('width', h.width);
      rect.setAttribute('height', h.height);
      rect.setAttribute('class', 'habitacion');
      habitacionesGroup.appendChild(rect);

      const texto = createText(h.x + 10, h.y + 20, `Habitación ${h.id}`);
      habitacionesGroup.appendChild(texto);

      if (h.id === idHabitacion) {
        const tramo1 = crearLinea(
          entradaCenter.x,
          entradaCenter.y,
          puerta.x,
          entradaCenter.y
        );
        const tramo2 = crearLinea(
          puerta.x,
          entradaCenter.y,
          puerta.x,
          puerta.y
        );
        rutasGroup.appendChild(tramo1);
        rutasGroup.appendChild(tramo2);

        targetHabitacion = h;
      }
    });

    contPlano.appendChild(svg);

    // Crear QR abajo
    if (targetHabitacion) {
      const qrDiv = document.createElement('div');
      qrDiv.className = 'qr-container';

      const urlPlano = `${baseUrl}?hab=${targetHabitacion.id}`;
      QRCode.toDataURL(urlPlano, { width: 100, margin: 1 }, (err, url) => {
        if (err) console.error(err);
        const img = document.createElement('img');
        img.src = url;
        img.alt = `Código QR para Habitación ${targetHabitacion.id}`;
        qrDiv.appendChild(img);
        contPlano.appendChild(qrDiv);
      });
    }
  }
</script>

</body>
</html>
