<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Planos con Ruta Individual y QR con URL</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 20px;
      background: #f9fafb;
      color: #333;
    }

    h1 {
      text-align: center;
      font-weight: 700;
      font-size: 2.2rem;
      margin-bottom: 40px;
      color: #222;
    }

    .plano-container {
      margin: 0 auto 50px auto;
      max-width: 900px;
      border-radius: 10px;
      box-shadow: 0 6px 15px rgba(0,123,255,0.2);
      background: #ffffff;
      overflow: hidden;
      position: relative;
    }

    .plano-titulo {
      text-align: center;
      font-weight: 700;
      padding: 15px 0;
      background-color: #007BFF;
      color: #fff;
      font-size: 1.5rem;
    }

    .plano-botones {
      text-align: center;
      margin: 10px 0 20px 0;
    }

    .plano-botones button {
      margin: 5px;
      padding: 8px 14px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      background-color: #007BFF;
      color: white;
      transition: background-color 0.3s ease;
    }

    .plano-botones button:hover {
      background-color: #0056b3;
    }

    svg {
      display: block;
      margin: 10px auto 0 auto;
      max-width: 100%;
      height: auto;
      background: #f7f9fc;
    }

    .habitacion {
      fill: #e2e8f0;
      stroke: #3b82f6;
      stroke-width: 3;
    }

    text {
      font-size: 14px;
      font-weight: 600;
      pointer-events: none;
      user-select: none;
    }

    .qr-border {
      fill: white;
      stroke: #007BFF;
      stroke-width: 2;
      rx: 6;
      ry: 6;
    }

    .qr-image {
      pointer-events: none;
    }

    .volver-btn {
      display: block;
      margin: 0 auto 20px auto;
      max-width: 120px;
      padding: 10px;
      background: #6c757d;
      color: white;
      font-weight: 600;
      text-align: center;
      border-radius: 8px;
      cursor: pointer;
      text-decoration: none;
      transition: background-color 0.3s ease;
    }
    .volver-btn:hover {
      background-color: #495057;
    }
  </style>
</head>
<body>

<h1>Planos con Ruta Individual y QR</h1>

<a href="index.html" class="volver-btn">← Volver al Índice</a>

<div id="contenedor-planos"></div>

<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>
<script>
  const svgNS = "http://www.w3.org/2000/svg";
  const baseUrl = window.location.origin + window.location.pathname.replace('plano.html', 'plano.html'); // Ajusta si está en otra ruta

  const entrada = { x: 10, y: 170, width: 60, height: 60 };
  const entradaCenter = { x: entrada.x + entrada.width / 2, y: entrada.y + entrada.height / 2 };

  const habitaciones = [];
  for (let i = 1; i <= 10; i++) {
    const fila = i <= 5 ? 50 : 250;
    const col = ((i - 1) % 5) * 140 + 100;
    habitaciones.push({ id: i, x: col, y: fila, width: 120, height: 120 });
  }

  function createText(x, y, content, options = {}) {
    const t = document.createElementNS(svgNS, 'text');
    t.setAttribute('x', x);
    t.setAttribute('y', y);
    t.textContent = content;
    t.setAttribute('fill', options.fill || '#000');
    t.setAttribute('font-weight', options.fontWeight || 'bold');
    if (options.anchor) t.setAttribute('text-anchor', options.anchor);
    return t;
  }

  function crearLinea(x1, y1, x2, y2) {
    const line = document.createElementNS(svgNS, 'line');
    line.setAttribute('x1', x1);
    line.setAttribute('y1', y1);
    line.setAttribute('x2', x2);
    line.setAttribute('y2', y2);
    line.setAttribute('stroke', '#007BFF');
    line.setAttribute('stroke-width', '3');
    return line;
  }

  function crearFlecha(x, y, direction) {
    const arrow = document.createElementNS(svgNS, 'path');
    const size = 10;
    let d = '';
    switch (direction) {
      case 'right': d = `M${x - size},${y - size} L${x},${y} L${x - size},${y + size}`; break;
      case 'left':  d = `M${x + size},${y - size} L${x},${y} L${x + size},${y + size}`; break;
      case 'up':    d = `M${x - size},${y + size} L${x},${y} L${x + size},${y + size}`; break;
      case 'down':  d = `M${x - size},${y - size} L${x},${y} L${x + size},${y - size}`; break;
    }
    arrow.setAttribute('d', d);
    arrow.setAttribute('fill', 'none');
    arrow.setAttribute('stroke', '#007BFF');
    arrow.setAttribute('stroke-width', '3');
    arrow.setAttribute('stroke-linecap', 'round');
    arrow.setAttribute('stroke-linejoin', 'round');
    return arrow;
  }

  const contenedor = document.getElementById('contenedor-planos');

  function crearPlanoParaHabitacion(idHabitacion) {
    const contPlano = document.createElement('div');
    contPlano.classList.add('plano-container');

    const titulo = document.createElement('div');
    titulo.classList.add('plano-titulo');
    titulo.textContent = `Plano con Ruta a Habitación ${idHabitacion}`;
    contPlano.appendChild(titulo);

    const svg = document.createElementNS(svgNS, 'svg');
    svg.setAttribute('width', '900');
    svg.setAttribute('height', '400');
    svg.setAttribute('viewBox', '0 0 900 400');

    // Entrada
    const rectEntrada = document.createElementNS(svgNS, 'rect');
    rectEntrada.setAttribute('x', entrada.x);
    rectEntrada.setAttribute('y', entrada.y);
    rectEntrada.setAttribute('width', entrada.width);
    rectEntrada.setAttribute('height', entrada.height);
    rectEntrada.setAttribute('fill', 'green');
    svg.appendChild(rectEntrada);

    const textoEntrada = createText(
      entrada.x + entrada.width / 2,
      entrada.y - 8,
      'Entrada',
      { fill: 'green', anchor: 'middle' }
    );
    svg.appendChild(textoEntrada);

    // Habitaciones
    habitaciones.forEach(hab => {
      const rect = document.createElementNS(svgNS, 'rect');
      rect.setAttribute('x', hab.x);
      rect.setAttribute('y', hab.y);
      rect.setAttribute('width', hab.width);
      rect.setAttribute('height', hab.height);
      rect.setAttribute('class', 'habitacion');
      if (hab.id === idHabitacion) {
        rect.setAttribute('fill', '#D6E4FF');
        rect.setAttribute('stroke', '#003d99');
        rect.setAttribute('stroke-width', '4');
      }
      svg.appendChild(rect);

      const textoHab = createText(
        hab.x + hab.width / 2,
        hab.y + hab.height / 2 + 6,
        hab.id,
        { anchor: 'middle', fill: '#003d99' }
      );
      svg.appendChild(textoHab);
    });

    // Ruta desde la entrada hasta la habitación
    const habitacion = habitaciones.find(h => h.id === idHabitacion);
    if (habitacion) {
      // Ejemplo de ruta simple (líneas) — ajusta según tu plano
      // Desde centro entrada al centro habitación

      // Primer tramo horizontal desde entrada
      const pathGroup = document.createElementNS(svgNS, 'g');

      // Línea horizontal desde centro entrada a x de habitación - 40
      const startX = entradaCenter.x;
      const startY = entradaCenter.y;

      const midX1 = habitacion.x - 40;
      const midY1 = startY;

      const midX2 = midX1;
      const midY2 = habitacion.y + habitacion.height / 2;

      const endX = habitacion.x + habitacion.width / 2;
      const endY = midY2;

      // Líneas ruta
      pathGroup.appendChild(crearLinea(startX, startY, midX1, midY1));
      pathGroup.appendChild(crearFlecha(midX1, midY1, 'right'));

      pathGroup.appendChild(crearLinea(midX1, midY1, midX2, midY2));
      pathGroup.appendChild(crearFlecha(midX2, midY2, 'down'));

      pathGroup.appendChild(crearLinea(midX2, midY2, endX, endY));
      pathGroup.appendChild(crearFlecha(endX, endY, 'right'));

      svg.appendChild(pathGroup);
    }

    // Código QR en esquina inferior derecha
    const qrGroup = document.createElementNS(svgNS, 'g');
    const qrSize = 120;
    const qrX = 900 - qrSize - 20;
    const qrY = 400 - qrSize - 20;

    // Fondo blanco para QR
    const qrBack = document.createElementNS(svgNS, 'rect');
    qrBack.setAttribute('x', qrX - 8);
    qrBack.setAttribute('y', qrY - 8);
    qrBack.setAttribute('width', qrSize + 16);
    qrBack.setAttribute('height', qrSize + 16);
    qrBack.setAttribute('class', 'qr-border');
    qrGroup.appendChild(qrBack);

    // QR generado dinámicamente y convertido a imagen SVG dentro del grupo
    const qrCanvas = document.createElement('canvas');
    QRCode.toCanvas(qrCanvas, `${baseUrl}?hab=${idHabitacion}`, { width: qrSize }, function (error) {
      if (error) {
        console.error(error);
        return;
      }

      // Crear imagen SVG para el QR
      const img = document.createElementNS(svgNS, 'image');
      img.setAttributeNS('http://www.w3.org/1999/xlink', 'href', qrCanvas.toDataURL());
      img.setAttribute('x', qrX);
      img.setAttribute('y', qrY);
      img.setAttribute('width', qrSize);
      img.setAttribute('height', qrSize);
      img.setAttribute('class', 'qr-image');

      qrGroup.appendChild(img);
    });

    svg.appendChild(qrGroup);

    // Botones para imprimir y compartir
    const botonesDiv = document.createElement('div');
    botonesDiv.classList.add('plano-botones');

    const btnImprimir = document.createElement('button');
    btnImprimir.textContent = 'Imprimir Plano';
    btnImprimir.onclick = () => {
      const ventanaImprimir = window.open('', '_blank');
      ventanaImprimir.document.write(`
        <html><head><title>Imprimir Plano Habitación ${idHabitacion}</title></head><body>
        <h2>Plano Habitación ${idHabitacion}</h2>
        ${svg.outerHTML}
        </body></html>`);
      ventanaImprimir.document.close();
      ventanaImprimir.focus();
      ventanaImprimir.print();
      ventanaImprimir.close();
    };
    botonesDiv.appendChild(btnImprimir);

    const btnCompartir = document.createElement('button');
    btnCompartir.textContent = 'Copiar enlace';
    btnCompartir.onclick = () => {
      const url = `${baseUrl}?hab=${idHabitacion}`;
      navigator.clipboard.writeText(url)
        .then(() => alert('Enlace copiado al portapapeles:\n' + url))
        .catch(() => alert('Error al copiar el enlace'));
    };
    botonesDiv.appendChild(btnCompartir);

    contPlano.appendChild(botonesDiv);
    contPlano.appendChild(svg);

    return contPlano;
  }

  // Leer parámetro ?hab=
  function obtenerParametroHabitacion() {
    const params = new URLSearchParams(window.location.search);
    const hab = params.get('hab');
    return hab ? Number(hab) : null;
  }

  function mostrarPlanos() {
    const habParam = obtenerParametroHabitacion();

    if (habParam && habParam >= 1 && habParam <= 10) {
      // Mostrar solo el plano seleccionado
      contenedor.appendChild(crearPlanoParaHabitacion(habParam));
    } else {
      // Mostrar todos los planos
      for (let i = 1; i <= 10; i++) {
        contenedor.appendChild(crearPlanoParaHabitacion(i));
      }
    }
  }

  mostrarPlanos();
</script>
</body>
</html>
